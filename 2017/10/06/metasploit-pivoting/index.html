<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="pipefail">

    <title>Metasploit Pivoting through Victims - pipefail</title>

    <link rel="canonical" href="https://www.pipefail.io/2017/10/06/metasploit-pivoting/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Metasploit Pivoting through Victims | pipefail</title>
<meta property="og:title" content="Metasploit Pivoting through Victims" />
<meta name="author" content="Chris Lapa" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I’m currently working my way through the PTPv4 course offered by eLearn Security. One of the labs involves extending our reach to otherwise inaccessible networks by pivoting through a Victim that we already have an active Meterpreter session on." />
<meta property="og:description" content="I’m currently working my way through the PTPv4 course offered by eLearn Security. One of the labs involves extending our reach to otherwise inaccessible networks by pivoting through a Victim that we already have an active Meterpreter session on." />
<link rel="canonical" href="https://www.pipefail.io/2017/10/06/metasploit-pivoting/" />
<meta property="og:url" content="https://www.pipefail.io/2017/10/06/metasploit-pivoting/" />
<meta property="og:site_name" content="pipefail" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-10-06T00:00:00+00:00" />
<script type="application/ld+json">
{"name":null,"description":"I’m currently working my way through the PTPv4 course offered by eLearn Security. One of the labs involves extending our reach to otherwise inaccessible networks by pivoting through a Victim that we already have an active Meterpreter session on.","url":"https://www.pipefail.io/2017/10/06/metasploit-pivoting/","headline":"Metasploit Pivoting through Victims","dateModified":"2017-10-06T00:00:00+00:00","datePublished":"2017-10-06T00:00:00+00:00","sameAs":null,"@type":"BlogPosting","author":{"@type":"Person","name":"Chris Lapa"},"image":null,"publisher":null,"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.pipefail.io/2017/10/06/metasploit-pivoting/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">pipefail</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                <li>
                    <a href="/about/">About</a>
                </li>
                
                <li>
                    <a href="/contact/">Contact</a>
                </li>
                
                <li>
                    <a href="/ctf/">CTF's</a>
                </li>
                
                <li>
                    
                </li>
                
                <li>
                    
                </li>
                
                <li>
                    
                </li>
                
                <li>
                    
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'pipefail'; // required: replace example with your forum shortname
    /* var disqus_developer = 1; // Comment out when the site is live */

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/pivot.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1 style=color:#FFFFFF >Metasploit Pivoting through Victims</h1>
                    
                    <h2 style=color:#FFFFFF class="subheading">PIVOTTT!</h2>
                    
                    <span style=color:#FFFFFF class="meta">Posted by Chris Lapa on October 6, 2017</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<p>I’m currently working my way through the <a href="https://www.elearnsecurity.com/course/penetration_testing">PTPv4 course offered by eLearn Security</a>.
One of the labs involves extending our reach to otherwise inaccessible networks by pivoting through a Victim that we already have an active Meterpreter session on.</p>

<p>I’m going to skip the network discovery part and jump straight into the interesting bits! Therefore assume the network map looks like this:</p>

<script src="/js/mermaid.min.js"></script>
<div class="mermaid">
graph LR;
	me["ME: 172.16.5.40"];
	host1["VICTIM 1: 10.32.120.15"];
	host2["VICTIM 2: 10.32.121.23"];
	me ==&gt; host1;
	host1 ==&gt; host2;
</div>

<p>As seen below, we have an existing Meterpreter session active for <strong>Victim 1</strong>. We will be using this session to pivot via <strong>Victim 1</strong> to access <strong>Victim 2</strong>.</p>
<figure id="figure-1"><a href="/img/2017-10-13-metasploit-pivoting/sessions.png"><img src="/img/2017-10-13-metasploit-pivoting/sessions.png" alt="Meterpreter session on Victim 1" /></a><figcaption>Figure 1: Meterpreter session on Victim 1 [<a href="/img/2017-10-13-metasploit-pivoting/sessions.png">PNG</a>]</figcaption></figure>

<hr />
<h3 id="socks-module-setup">Socks Module Setup</h3>

<p>We will need to use the Socks4a Metasploit module to setup a proxy from Meterpreter to our system. The Socks proxy is required because Meterpreter uses its own separate routing table vs what the host uses. Meaning only Metasploit can access the routes it sets up unless we use a proxy.</p>
<figure id="figure-2"><a href="/img/2017-10-13-metasploit-pivoting/socks_setup.png"><img src="/img/2017-10-13-metasploit-pivoting/socks_setup.png" alt="Socks Proxy Module" /></a><figcaption>Figure 2: Socks Proxy Module [<a href="/img/2017-10-13-metasploit-pivoting/socks_setup.png">PNG</a>]</figcaption></figure>

<hr />
<h3 id="adding-default-routes">Adding Default Routes</h3>
<p>Next up we will use the Autoroute module with the <strong>CMD</strong> set to <strong>default</strong> and the <strong>SESSION</strong> set to 14 (see Figure 1). The <strong>SUBNET</strong> setting is
not required when using <strong>default</strong>.
This tells Metasploit to add a default route to its routing table, routing all traffic Metasploit see’s through <strong>VICTIM 1</strong>. When combined with the Socks proxy setup previously, it allows access to any system that <strong>VICTIM 1</strong> can access via our machine.</p>
<figure id="figure-3"><a href="/img/2017-10-13-metasploit-pivoting/autoroute.png"><img src="/img/2017-10-13-metasploit-pivoting/autoroute.png" alt="Autoroute Module" /></a><figcaption>Figure 3: Autoroute Module [<a href="/img/2017-10-13-metasploit-pivoting/autoroute.png">PNG</a>]</figcaption></figure>

<hr />
<h3 id="foxyproxy">Foxyproxy</h3>
<p>The final step is to use our proxy outside of Metasploit. In this case, I’m using FoxyProxy in Firefox but another common
route is to use proxychains (which comes installed by default in Kali).</p>
<figure id="figure-4"><a href="/img/2017-10-13-metasploit-pivoting/foxyproxy.png"><img src="/img/2017-10-13-metasploit-pivoting/foxyproxy.png" alt="FoxyProxy Setup" /></a><figcaption>Figure 4: FoxyProxy Setup [<a href="/img/2017-10-13-metasploit-pivoting/foxyproxy.png">PNG</a>]</figcaption></figure>

<hr />
<h3 id="testing">Testing</h3>
<p>All thats left to do is to test we can accesss <strong>VICTIM 2</strong> via Firefox, and as seen in Figure 5 it works!</p>
<figure id="figure-5"><a href="/img/2017-10-13-metasploit-pivoting/test.png"><img src="/img/2017-10-13-metasploit-pivoting/test.png" alt="Testing" /></a><figcaption>Figure 5: Testing [<a href="/img/2017-10-13-metasploit-pivoting/test.png">PNG</a>]</figcaption></figure>

<hr />
<h3 id="takeaways">Takeaway’s</h3>
<ul>
  <li>Metasploits routing table != system routing table</li>
  <li>Pivoting is a great way to gain access to networks that aren’t connected to the internet!</li>
</ul>

<h4 id="sources">Sources:</h4>
<ul>
  <li><a href="https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/post/multi/manage/autoroute.md">https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/post/multi/manage/autoroute.md</a></li>
</ul>


                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2017/10/06/network-manager/" data-toggle="tooltip" data-placement="top" title="Working with Network Manager">&larr; Previous Post</a>
                    </li>
                    
                    
                </ul>
                
                <div id="disqus_thread"></div>
                    <script type="text/javascript">
                        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                        var disqus_shortname = 'pipefail'; // required: replace example with your forum shortname
                        // var disqus_developer = 1; // Comment out when the site is live
                        var disqus_identifier = "/2017/10/06/metasploit-pivoting/";

                        /* * * DON'T EDIT BELOW THIS LINE * * */
                        (function() {
                            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                        })();
                    </script>
                    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                    <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                
            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/Gus_Bricker">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/GusBricker">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="http://ko-fi.com/Buttons/Buy/574E2ZGZ45MK">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-coffee fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; Chris Lapa 2017</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>

</div>
</body>

</html>
